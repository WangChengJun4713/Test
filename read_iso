from PIL import Image
from openpyxl import Workbook
import os

# 创建Excel工作簿
wb = Workbook()
ws = wb.active
ws.append(["Filename", "Exposure Time", "ISO"])

# 文件夹路径
root_folder_path = r"D:\MCE"
result = []
# 遍历文件夹及其子文件夹中的图片
for dirpath, _, filenames in os.walk(root_folder_path):
    first_image_found = False  # 标志，用于检测是否已经找到第一张图片
    for filename in filenames:
        if filename.lower().endswith(('.png', '.jpg', '.jpeg')) and not first_image_found:
            img_path = os.path.join(dirpath, filename)
            img = Image.open(img_path)

            # 获取EXIF数据
            exif_data = img._getexif()
            if exif_data:
                exposure_time = exif_data.get(33434)  # Exposure Time
                iso = exif_data.get(34855)  # ISO Speed Ratings

                # 格式化曝光时间
                if exposure_time is not None:
                    if isinstance(exposure_time, tuple):  # 如果是元组，表示分数
                        exposure_time = f"{exposure_time[0]}/{exposure_time[1]}"
                    else:
                        exposure_time = str(exposure_time)

                # 添加到Excel
                result.append([img_path, exposure_time, iso])
            
            first_image_found = True  # 找到第一张图片后更新标志
result = sorted(result, key=lambda x : int(x[0].split("\\")[3].split('Lux')[0]))

for i in result:
    ws.append(i)

# 保存Excel文件
wb.save('image_data.xlsx')
